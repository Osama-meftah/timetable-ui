{% extends 'base.html' %}
{% load static %}

{% block page_header_title %}
    إدارة القاعات
{% endblock %}

{% block content %}

{# قسم الإحصائيات - لوحات معلومات عصرية مع تأثيرات عمق #}
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mt-8 mb-12 px-4 sm:px-6 lg:px-8">
    {# بطاقة إجمالي القاعات #}
    <div class="relative bg-gradient-to-br from-blue-600 to-blue-800 dark:from-blue-800 dark:to-blue-950 text-white rounded-2xl shadow-xl p-7 flex items-center justify-between overflow-hidden group transform hover:scale-105 transition-all duration-300 ease-in-out cursor-pointer">
        <div class="absolute inset-0 bg-black opacity-10 rounded-2xl"></div> {# طبقة شفافة للعمق #}
        <i class="fas fa-building text-6xl opacity-15 absolute -bottom-4 -right-4 group-hover:rotate-6 transition-transform duration-300"></i>
        <div class="z-10">
            <p class="text-sm font-light opacity-90 mb-1">إجمالي القاعات</p>
            <p class="text-5xl font-extrabold leading-none">{{ stats.total_rooms }}</p>
        </div>
    </div>

    {# بطاقة أكبر سعة #}
    <div class="relative bg-gradient-to-br from-purple-600 to-purple-800 dark:from-purple-800 dark:to-purple-950 text-white rounded-2xl shadow-xl p-7 flex items-center justify-between overflow-hidden group transform hover:scale-105 transition-all duration-300 ease-in-out cursor-pointer">
        <div class="absolute inset-0 bg-black opacity-10 rounded-2xl"></div>
        <i class="fas fa-chair text-6xl opacity-15 absolute -bottom-4 -right-4 group-hover:rotate-6 transition-transform duration-300"></i>
        <div class="z-10">
            <p class="text-sm font-light opacity-90 mb-1">أكبر سعة قاعة</p>
            <p class="text-5xl font-extrabold leading-none">{{ stats.largest_capacity_room.capacity_hall|default:'N/A' }}</p>
            {% if stats.largest_capacity_room %}
            <p class="text-xs opacity-70 mt-1">({{ stats.largest_capacity_room.hall_name|default:'---' }})</p>
            {% endif %}
        </div>
    </div>

    {# بطاقة توزيع السعة #}
    <div class="relative bg-gradient-to-br from-orange-600 to-orange-800 dark:from-orange-800 dark:to-orange-950 text-white rounded-2xl shadow-xl p-7 flex items-center justify-between overflow-hidden group transform hover:scale-105 transition-all duration-300 ease-in-out cursor-pointer">
        <div class="absolute inset-0 bg-black opacity-10 rounded-2xl"></div>
        <i class="fas fa-chart-bar text-6xl opacity-15 absolute -bottom-4 -right-4 group-hover:rotate-6 transition-transform duration-300"></i>
        <div class="z-10">
            <p class="text-sm font-light opacity-90 mb-1">توزيع السعة</p>
            <div class="mt-2 text-3xl font-extrabold leading-tight">
                {% if stats.capacity_counts %}
                    {% for capacity, count in stats.capacity_counts.items %}
                        <p class="text-xl font-bold leading-tight">{{ count }} <span class="text-sm font-normal">قاعة بسعة</span> {{ capacity }}</p>
                    {% endfor %}
                {% else %}
                    <p class="text-2xl">لا توجد بيانات</p>
                {% endif %}
            </div>
        </div>
    </div>

    {# بطاقة تحت الصيانة #}
    <div class="relative bg-gradient-to-br from-red-600 to-red-800 dark:from-red-800 dark:to-red-950 text-white rounded-2xl shadow-xl p-7 flex items-center justify-between overflow-hidden group transform hover:scale-105 transition-all duration-300 ease-in-out cursor-pointer">
        <div class="absolute inset-0 bg-black opacity-10 rounded-2xl"></div>
        <i class="fas fa-tools text-6xl opacity-15 absolute -bottom-4 -right-4 group-hover:rotate-6 transition-transform duration-300"></i>
        <div class="z-10">
            <p class="text-sm font-light opacity-90 mb-1">تحت الصيانة</p>
            <p class="text-5xl font-extrabold leading-none">{{ stats.maintenance_rooms }}</p>
        </div>
    </div>
</div>
{% if messages %}
  <div class="mb-4 px-4"> {# Added padding here for messages #}
    {% for message in messages %}
      <div class="rounded-md px-4 py-3 text-sm font-medium 
                    {% if message.tags == 'error' %}
                      bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100
                    {% elif message.tags == 'success' %}
                      bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100
                    {% else %}
                      bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-100
                    {% endif %}
                    flex items-center justify-between">
        <span>{{ message }}</span>
        {# Optional: Add a close button for messages #}
        <button type="button" class="ml-auto -mx-1.5 -my-1.5 bg-transparent text-current rounded-lg p-1.5 hover:bg-current hover:bg-opacity-20 focus:ring-2 focus:ring-current focus:ring-opacity50 inline-flex h-8 w-8 dark:hover:bg-current dark:hover:bg-opacity-20" onclick="this.parentElement.style.display='none';">
          <span class="sr-only">Close</span>
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
        </button>
      </div>
    {% endfor %}
  </div>
{% endif %}

{# قسم إدارة القاعات - العنوان وزر الإضافة #}
<div class="container mx-auto px-4 py-8 sm:px-6 lg:px-8">
    <div class="bg-white dark:bg-gray-800 shadow-2xl rounded-2xl p-6 sm:p-8 border border-gray-100 dark:border-gray-700">
        {# Button to trigger file upload modal #}
        <div class="flex flex-col sm:flex-row items-center justify-between mb-8 gap-4 border-b pb-6 border-gray-200 dark:border-gray-700">
            <h2 class="text-3xl font-extrabold text-gray-900 dark:text-gray-100 whitespace-nowrap">إدارة القاعات</h2>
            <div class="flex items-center gap-4">
                <button type="button" id="openFileUploadModal" class="bg-blue-600 hover:bg-blue-700 text-white dark:text-gray-200 font-bold
                  py-2.5 px-5 rounded-md flex items-center shadow-md transition-all duration-200 transform
                  hover:scale-[1.02] active:scale-[0.98] w-full sm:w-auto justify-center group">
                    <i class="fas fa-upload ml-2 group-hover:rotate-6 transition-transform duration-200"></i>
                    رفع ملف بيانات القاعات
                </button>
                <a href="{% url 'add_room' %}?add=1" class="inline-flex items-center px-6 py-3 border
                border-transparent rounded-lg shadow-md block text-base font-bold dark:text-gray-200 text-white bg-indigo-600
                hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] w-full sm:w-auto justify-center group">
                    <i class="fas fa-plus ml-2 group-hover:rotate-6 transition-transform duration-200"></i>
                    إضافة قاعة جديدة
                </a>
            </div>
        </div>

        {# شبكة البطاقات للقاعات #}
        {% if rooms %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mt-8">
            {% for room in rooms %}
            <div class="bg-white dark:bg-gray-700 rounded-xl shadow-lg p-6 border border-gray-200 dark:border-gray-600 flex flex-col justify-between transform hover:scale-[1.01] hover:shadow-xl transition-all duration-200 ease-in-out">
                <div class="flex-grow">
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-3 leading-tight">{{ room.hall_name }}</h3>
                    
                    <p class="text-gray-700 dark:text-gray-300 mb-3 flex items-center text-base">
                        <i class="fas fa-users-line ml-2 text-gray-500 dark:text-gray-400 text-lg"></i>
                        السعة: <span class="font-semibold text-gray-800 dark:text-gray-200 mr-1">{{ room.capacity_hall }}</span>
                    </p>
                    
                    <div class="mb-4 flex items-center">
                        <span class="text-base font-medium text-gray-700 dark:text-gray-300 ml-2">الحالة:</span>
                        {% if room.hall_status == 'متاحة' %} {# Changed from room.status to room.hall_status #}
                            <span class="px-3 py-1.5 inline-flex text-sm leading-5 font-bold rounded-full bg-green-100 text-green-800 dark:bg-green-700 dark:text-green-100 shadow-sm">
                                <i class="fas fa-circle-check text-green-600 dark:text-green-300 ml-1 text-sm"></i> متاحة
                            </span>
                        {% elif room.hall_status == 'مشغولة' %} {# Changed from room.status to room.hall_status #}
                            <span class="px-3 py-1.5 inline-flex text-sm leading-5 font-bold rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-700 dark:text-yellow-100 shadow-sm">
                                <i class="fas fa-users-rectangle text-yellow-600 dark:text-yellow-300 ml-1 text-sm"></i> مشغولة
                            </span>
                        {% elif room.hall_status == 'تحت الصيانة' %} {# Changed from room.status to room.hall_status #}
                            <span class="px-3 py-1.5 inline-flex text-sm leading-5 font-bold rounded-full bg-red-100 text-red-800 dark:bg-red-700 dark:text-red-100 shadow-sm">
                                <i class="fas fa-screwdriver-wrench text-red-600 dark:text-red-300 ml-1 text-sm"></i> تحت الصيانة
                            </span>
                        {% else %}
                            <span class="px-3 py-1.5 inline-flex text-sm leading-5 font-bold rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 shadow-sm">
                                {{ room.hall_status }} {# Changed from room.status to room.hall_status #}
                            </span>
                        {% endif %}
                    </div>
                </div>
                
                {# أزرار الإجراءات في أسفل البطاقة #}
                <div class="flex justify-end gap-3 mt-5 border-t border-gray-200 dark:border-gray-600 pt-4">
                    <a href="{% url 'edit_room' room.id %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-indigo-600 bg-indigo-100 hover:bg-indigo-200 dark:bg-indigo-700 dark:text-indigo-100 dark:hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200 group">
                        <i class="fas fa-edit ml-2 group-hover:scale-105 transition-transform"></i> تعديل
                    </a>
                    {# Trigger button for the Delete Modal #}
                    <button type="button" 
                            class="open-delete-modal inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-red-600 bg-red-100 hover:bg-red-200 dark:bg-red-700 dark:text-red-100 dark:hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200 group"
                            data-room-id="{{ room.id }}"
                            data-room-name="{{ room.hall_name }}"> {# Pass room name for display in modal #}
                        <i class="fas fa-trash-alt ml-2 group-hover:scale-105 transition-transform"></i> حذف
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-center text-xl font-medium text-gray-500 dark:text-gray-400 py-10">
            <i class="fas fa-info-circle ml-2"></i> لا توجد قاعات لعرضها حالياً.
        </p>
        {% endif %}
    </div>
</div>

{# --- DELETE CONFIRMATION MODAL --- #}
<div id="deleteModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 invisible">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md p-6 md:p-8 transform scale-95 transition-transform duration-300">
        <div class="flex items-start justify-between mb-4">
            <div class="flex items-center gap-3">
                <div class="text-red-600 dark:text-red-400 text-2xl">
                    <i class="fas fa-exclamation-triangle animate-pulse"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">تأكيد الحذف</h3>
            </div>
            <button type="button" class="close-modal text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <p class="text-gray-700 dark:text-gray-300 text-sm md:text-base leading-relaxed mb-6">
            هل أنت متأكد من حذف القاعة
            <strong id="modalRoomName" class="text-red-600 dark:text-red-400"></strong>؟
            هذا الإجراء لا يمكن التراجع عنه.
        </p>

        <div class="flex justify-start gap-3">
            <button type="button"
                    id="confirmDeleteBtn"
                    class="px-5 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg shadow-md transition flex items-center gap-2">
                <i class="fas fa-trash-alt"></i>
                <span>تأكيد الحذف</span>
            </button>
            <button type="button"
                    class="close-modal px-5 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                إلغاء
            </button>
        </div>
    </div>
</div>


{# --- HIDDEN FORM FOR DELETION --- #}
{# This form's action will be updated by JavaScript and then submitted #}
<form id="deleteRoomForm" method="post" action="" class="hidden">
    {% csrf_token %}
    <input type="hidden" name="form_type" value="delete">
    <input type="hidden" name="room_id" id="hiddenRoomId">
</form>

{# File Upload Modal - NEW #}
<div id="fileUploadModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden opacity-0 transition-opacity duration-300">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md transform scale-95 transition-transform duration-300">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100">رفع ملف بيانات القاعات</h3>
            <button type="button" id="closeFileUploadModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors duration-200">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
            يمكنك رفع ملف CSV أو Excel يحتوي على بيانات القاعات لإضافتها أو تحديثها دفعة واحدة.
            يجب أن يحتوي الملف على أعمدة مطابقة لـ: 
            </code>, <code class="bg-gray-100 dark:bg-gray-700 px-1 py-0.5 rounded text-xs">hall_name

            </code>, <code class="bg-gray-100 dark:bg-gray-700 px-1 py-0.5 rounded text-xs">capacity_hall</code>,
             <code class="bg-gray-100 dark:bg-gray-700 px-1 py-0.5 rounded text-xs">hall_status</code>.
        </p>
        <form method="post" enctype="multipart/form-data" id="courseFileUploadForm" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="upload_rooms"> {# Differentiate this form submission #}
            <div>
                <label for="data_file" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    اختر ملف البيانات
                </label>
                <input
                    type="file"
                    name="data_file" {# Changed name to be specific for courses #}
                    id="data_file"
                    accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" {# Accept CSV and Excel files #}
                    required
                    class="mt-1 block w-full text-sm text-gray-900
                           bg-gray-200 border border-gray-300 rounded-lg cursor-pointer
                           dark:text-gray-400 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400
                           file:mr-4 file:py-2 file:px-4
                           file:rounded-lg file:border-0 file:text-sm file:font-semibold
                           file:bg-green-50 file:text-green-700 hover:file:bg-green-100
                           file:transition-colors file:duration-200 file:ease-in-out
                           dark:file:bg-green-900 dark:file:text-green-100 dark:hover:file:bg-green-800"
                />
            </div>
            <div class="flex justify-start gap-3 mt-6">
                <button
                    type="submit"
                    class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200"
                >
                    رفع الملف
                </button>
                <button type="button" id="cancelFileUploadButton" class="inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-700 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:text-sm transition-colors duration-200">
                    إلغاء
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const openBtn = document.getElementById("openFileUploadModal");
        const closeBtn = document.getElementById("closeFileUploadModal");
        const cancelBtn = document.getElementById("cancelFileUploadButton");
        const modal = document.getElementById("fileUploadModal");

        function openModal() {
            modal.classList.remove("hidden", "opacity-0", "scale-95");
            modal.classList.add("opacity-100", "scale-100");
        }

        function closeModal() {
            modal.classList.add("opacity-0", "scale-95");
            setTimeout(() => modal.classList.add("hidden"), 300); // match transition duration
        }

        if (openBtn) openBtn.addEventListener("click", openModal);
        if (closeBtn) closeBtn.addEventListener("click", closeModal);
        if (cancelBtn) cancelBtn.addEventListener("click", closeModal);
    });
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const deleteButtons = document.querySelectorAll('.open-delete-modal');
    const deleteModal = document.getElementById('deleteModal');
    const closeModalButtons = document.querySelectorAll('.close-modal');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const modalRoomName = document.getElementById('modalRoomName');
    const deleteRoomForm = document.getElementById('deleteRoomForm');
    const hiddenRoomId = document.getElementById('hiddenRoomId');

    let currentRoomId = null;

    function showModal() {
        deleteModal.classList.remove('opacity-0', 'invisible');
        deleteModal.classList.add('opacity-100', 'visible');
        deleteModal.querySelector('.max-w-md').classList.remove('scale-95');
        deleteModal.querySelector('.max-w-md').classList.add('scale-100');
    }

    function hideModal() {
        deleteModal.classList.remove('opacity-100', 'visible');
        deleteModal.classList.add('opacity-0', 'invisible');
        deleteModal.querySelector('.max-w-md').classList.remove('scale-100');
        deleteModal.querySelector('.max-w-md').classList.add('scale-95');
        currentRoomId = null;
    }

    deleteButtons.forEach(button => {
        button.addEventListener('click', function () {
            currentRoomId = this.dataset.roomId;
            const roomName = this.dataset.roomName;
            modalRoomName.textContent = roomName;
            showModal();
        });
    });

    closeModalButtons.forEach(button => {
        button.addEventListener('click', hideModal);
    });

    deleteModal.addEventListener('click', function (event) {
        if (event.target === deleteModal) {
            hideModal();
        }
    });

    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape' && deleteModal.classList.contains('visible')) {
            hideModal();
        }
    });

    confirmDeleteBtn.addEventListener('click', function () {
        if (currentRoomId) {
            hiddenRoomId.value = currentRoomId;
            deleteRoomForm.submit();
        }
        hideModal();
    });
});
</script>
{% endblock %}