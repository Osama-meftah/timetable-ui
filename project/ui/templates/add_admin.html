{% extends "base2.html" %} {# استبدل هذا باسم القالب الأساسي لديك #}
{% load static %}
{% block title %}إدارة المستخدمين والصلاحيات{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">

    <!-- قسم قائمة المستخدمين -->
    <div id="userListSection">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100">المستخدمون</h1>
            <button id="showCreateUserFormBtn" type="button" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-all duration-300 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                إنشاء مستخدم جديد
            </button>
        </div>
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6">
            <div id="userSelectionContainer">
                <label for="userSelectDropdown" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">اختر مستخدماً لتعديل صلاحياته:</label>
                <div class="flex items-center space-x-3 rtl:space-x-reverse">
                    <select id="userSelectDropdown" class="w-full pl-3 pr-10 py-2 bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 text-gray-900 dark:text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="" disabled selected>جاري تحميل المستخدمين...</option>
                    </select>
                    <button id="goToEditBtn" type="button" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 cursor-not-allowed" disabled>تعديل</button>
                </div>
            </div>
        </div>
    </div>

    <!-- قسم الإنشاء والتعديل -->
    <div id="editOrCreateSection" class="hidden">
        <button id="backToListBtn" class="mb-4 text-sm font-medium text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
            الرجوع إلى قائمة المستخدمين
        </button>
        
        <div id="stepper" class="flex items-center mb-8">
             <div id="stepper-1" class="flex items-center text-blue-600"><div class="rounded-full transition-all duration-500 flex items-center justify-center border-2 border-blue-600 h-10 w-10"><span class="font-bold text-lg">1</span></div><div class="text-sm font-semibold ml-3">البيانات الأساسية</div></div>
             <div id="stepper-line" class="flex-auto border-t-2 transition-all duration-500 border-gray-300 dark:border-slate-700 mx-4"></div>
             <div id="stepper-2" class="flex items-center text-gray-500 dark:text-gray-400"><div class="rounded-full transition-all duration-500 flex items-center justify-center border-2 border-gray-300 dark:border-slate-600 h-10 w-10"><span class="font-bold text-lg">2</span></div><div class="text-sm font-semibold ml-3">تعيين الصلاحيات</div></div>
        </div>

        <div class="bg-white dark:bg-slate-800 p-6 sm:p-8 rounded-xl shadow-lg">
            <div id="createUserSection">
                 <h2 class="text-2xl font-bold mb-1 text-gray-800 dark:text-gray-100">إنشاء مستخدم جديد</h2>
                 <p class="text-gray-500 dark:text-gray-400 mb-6">املأ البيانات الأساسية للمستخدم الجديد.</p>
                 <form id="createUserForm" class="space-y-5">
                    <div id="formErrors" class="hidden bg-red-50 dark:bg-red-900/20 border border-red-300 dark:border-red-500/30 text-red-700 dark:text-red-400 px-4 py-3 rounded-lg"></div>
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">اسم المستخدم</label>
                        <div class="relative"><span class="absolute inset-y-0 left-0 flex items-center pl-3"><svg class="h-5 w-5 text-gray-400 dark:text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg></span><input type="text" id="username" class="w-full pl-10 pr-3 py-2 bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 text-gray-900 dark:text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"></div>
                        <div id="username-error" class="text-red-600 dark:text-red-500 text-xs mt-1"></div>
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">البريد الإلكتروني</label>
                        <div class="relative"><span class="absolute inset-y-0 left-0 flex items-center pl-3"><svg class="h-5 w-5 text-gray-400 dark:text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" /><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" /></svg></span><input type="email" id="email" class="w-full pl-10 pr-3 py-2 bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 text-gray-900 dark:text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"></div>
                        <div id="email-error" class="text-red-600 dark:text-red-500 text-xs mt-1"></div>
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">كلمة المرور</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3"><svg class="h-5 w-5 text-gray-400 dark:text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></svg>
                        </span>
                        <select name="stauts" id="password" class="w-full pl-10 pr-3 py-2 bg-white 
                        dark:bg-slate-700 border border-gray-300 dark:border-slate-600 text-gray-900 dark:text-white rounded-md 
                        focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">اختر حالة المستخدم</option>
                            <option value="active">نشط</option>
                            <option value="vacation">اجاز</option>
                        </select>
                        {% comment %} <input type="password" id="password" class=""> {% endcomment %}
                        </div> 
                        <div id="password-error" class="text-red-600 dark:text-red-500 text-xs mt-1"></div>
                    </div>
                    <button id="createUserBtn" type="submit" class="w-full flex justify-center items-center bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-300">
                        <span class="btn-text">إنشاء ومتابعة</span>
                        <svg class="animate-spin h-5 w-5 ml-3 hidden btn-spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                 </form>
            </div>
            
            <div id="permissionsSection" class="hidden">
                <h2 id="permissionsTitle" class="text-2xl font-bold mb-1 text-gray-800 dark:text-gray-100">تعيين دور المستخدم</h2>
                <p class="text-gray-500 dark:text-gray-400 mb-8">إدارة دور المستخدم <strong id="userNameDisplay" class="text-blue-600"></strong> في النظام.</p>
                <div id="permissions-success" class="hidden bg-green-50 dark:bg-green-900/20 border border-green-300 dark:border-green-500/30 text-green-700 dark:text-green-400 px-4 py-3 rounded-lg mb-6"></div>
                <div class="space-y-6">
                    <label for="is_staff_toggle" class="flex items-center justify-between p-4 rounded-lg bg-slate-50 dark:bg-slate-700/50 cursor-pointer transition-all hover:ring-2 hover:ring-blue-500">
                        <div>
                            <h3 class="font-semibold text-gray-800 dark:text-gray-200">صلاحية موظف (Staff)</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">يسمح للمستخدم بالدخول إلى لوحة تحكم الأدمن.</p>
                        </div>
                        <div class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="is_staff_toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 dark:bg-gray-600 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-500 peer-checked:bg-blue-600"></div>
                        </div>
                    </label>
                    <label for="is_superuser_toggle" class="flex items-center justify-between p-4 rounded-lg bg-slate-50 dark:bg-slate-700/50 cursor-pointer transition-all hover:ring-2 hover:ring-blue-500">
                        <div>
                            <h3 class="font-semibold text-gray-800 dark:text-gray-200">صلاحية موظف (is_superuser)</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">  .يسمح للمستخدم بالدخول إلى لوحة تحكم الأدمن واضافة مستخدمين</p>
                        </div>
                        <div class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="is_superuser_toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 dark:bg-gray-600 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-500 peer-checked:bg-blue-600"></div>
                        </div>
                    </label>
                </div>
                <button id="savePermissionsBtn" class="w-full flex justify-center items-center bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-300 mt-8">
                    <span class="btn-text">حفظ الدور</span>
                    <svg class="animate-spin h-5 w-5 ml-3 hidden btn-spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // الخطوة 1: تمرير التوكن من Django إلى متغير JavaScript
    const authToken = "{{ request.session.token|escapejs }}";

    document.addEventListener('DOMContentLoaded', () => {
        // --- متغيرات الحالة وعناصر الواجهة ---
        let currentUserId = null;
        const API_BASE_URL = 'http://127.0.0.1:8001/api';

        const userListSection = document.getElementById('userListSection');
        const editOrCreateSection = document.getElementById('editOrCreateSection');
        const createUserSection = document.getElementById('createUserSection');
        const permissionsSection = document.getElementById('permissionsSection');
        const userSelectDropdown = document.getElementById('userSelectDropdown');
        const goToEditBtn = document.getElementById('goToEditBtn');
        const backToListBtn = document.getElementById('backToListBtn');
        const showCreateUserFormBtn = document.getElementById('showCreateUserFormBtn');
        const createUserForm = document.getElementById('createUserForm');
        const createUserBtn = document.getElementById('createUserBtn');
        const savePermissionsBtn = document.getElementById('savePermissionsBtn');
        const isStaffToggle = document.getElementById('is_staff_toggle');
        const isSuperUserToggle = document.getElementById('is_superuser_toggle');
        const userNameDisplay = document.getElementById('userNameDisplay');
        const formErrorsDiv = document.getElementById('formErrors');
        const permissionsSuccessDiv = document.getElementById('permissions-success');
        const stepper = document.getElementById('stepper');
        const stepper1Div = document.getElementById('stepper-1').querySelector('div');
        const stepper1Span = stepper1Div.querySelector('span');
        const stepper2Div = document.getElementById('stepper-2').querySelector('div');
        const stepperLine = document.getElementById('stepper-line');

        // --- دوال مساعدة ---
        
        function setButtonLoading(button, isLoading) {
            const text = button.querySelector('.btn-text');
            const spinner = button.querySelector('.btn-spinner');
            const btnElement = button;
            if (isLoading) {
                btnElement.disabled = true;
                if (text && spinner) {
                    text.classList.add('hidden');
                    spinner.classList.remove('hidden');
                }
            } else {
                btnElement.disabled = false;
                if (text && spinner) {
                    text.classList.remove('hidden');
                    spinner.classList.add('hidden');
                }
            }
        }

        function displayErrors(errors) {
            document.querySelectorAll('[id$="-error"]').forEach(el => { el.textContent = ''; });
            formErrorsDiv.innerHTML = '';
            formErrorsDiv.classList.add('hidden');
            let nonFieldErrors = [];
            for (const field in errors) {
                const errorDiv = document.getElementById(`${field}-error`);
                if (errorDiv) {
                    errorDiv.textContent = errors[field].join(', ');
                } else {
                    nonFieldErrors.push(`${field}: ${errors[field].join(', ')}`);
                }
            }
            if (nonFieldErrors.length > 0) {
                formErrorsDiv.innerHTML = nonFieldErrors.join('<br>');
                formErrorsDiv.classList.remove('hidden');
            }
        }

        function updateStepper(step, mode = 'create') {
            stepper1Div.className = 'rounded-full transition-all duration-500 flex items-center justify-center border-2 h-10 w-10 border-gray-300 dark:border-slate-600';
            stepper1Span.innerHTML = '1';
            stepper2Div.className = 'rounded-full transition-all duration-500 flex items-center justify-center border-2 h-10 w-10 border-gray-300 dark:border-slate-600';
            stepperLine.className = 'flex-auto border-t-2 transition-all duration-500 border-gray-300 dark:border-slate-700 mx-4';
            
            if (mode === 'create') {
                stepper.classList.remove('hidden');
                if (step === 1) {
                    stepper1Div.classList.remove('border-gray-300', 'dark:border-slate-600');
                    stepper1Div.classList.add('border-blue-600');
                } else if (step === 2) {
                    stepper1Div.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                    stepper1Span.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;
                    stepperLine.classList.remove('border-gray-300', 'dark:border-slate-700');
                    stepperLine.classList.add('border-blue-600');
                    stepper2Div.classList.remove('border-gray-300', 'dark:border-slate-600');
                    stepper2Div.classList.add('border-blue-600');
                }
            } else {
                stepper.classList.add('hidden');
            }
        }
        
        // --- دوال إدارة الواجهة ---
        function showView(viewName) {
            userListSection.classList.toggle('hidden', viewName !== 'list');
            editOrCreateSection.classList.toggle('hidden', viewName === 'list');
            if (viewName === 'list') {
                loadUsers();
            }
        }

        function showCreateForm() {
            showView('editOrCreate');
            permissionsSection.classList.add('hidden');
            createUserSection.classList.remove('hidden');
            updateStepper(1, 'create');
            createUserForm.reset();
            displayErrors({});
        }

        async function showPermissionsForm(userId, username, mode = 'create') {
            currentUserId = userId;
            userNameDisplay.textContent = username;
            
            showView('editOrCreate');
            createUserSection.classList.add('hidden');
            permissionsSection.classList.remove('hidden');
            permissionsSuccessDiv.classList.add('hidden');
            
            document.getElementById('permissionsTitle').textContent = `تعيين دور المستخدم`;
            updateStepper(mode === 'create' ? 2 : null, mode);

            setButtonLoading(savePermissionsBtn, true);
            await loadAndSetUserRole(userId); 
            setButtonLoading(savePermissionsBtn, false);
        }
        
        // --- دوال جلب البيانات والعمليات ---
        
        async function loadUsers() {
            userSelectDropdown.innerHTML = '<option value="" disabled selected>جاري تحميل...</option>';
            goToEditBtn.disabled = true;
            goToEditBtn.classList.add('bg-gray-500', 'cursor-not-allowed');
            goToEditBtn.classList.remove('bg-blue-600');
            try {
                const response = await fetch(`${API_BASE_URL}/teachers/?paginate=false`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error(`Network error`);
                const teachers = await response.json();
                
                userSelectDropdown.innerHTML = '<option value="" disabled selected>اختر معلماً</option>'; // تم تغيير النص ليكون أدق
                
                if (teachers.length === 0) {
                     userSelectDropdown.innerHTML = '<option value="" disabled selected>لا يوجد معلمون</option>';
                     return;
                }
        
                console.log("Data received from API:", teachers);
        
                teachers.forEach(teacher => {
                    // ==========================================================
                    //  الـحـل هـنـا: التحقق من وجود كائن user قبل استخدامه
                    // ==========================================================
                    if (teacher.user && teacher.user.id) {
                        const option = document.createElement('option');
                        option.value = teacher.user.id;
                        option.textContent = teacher.teacher_name;
                        userSelectDropdown.appendChild(option);
                    } else {
                        // هذا الجزء اختياري: يمكنك تسجيل المعلمين الذين ليس لديهم مستخدمون
                        console.warn(`المعلم '${teacher.teacher_name}' (ID: ${teacher.id}) ليس لديه حساب مستخدم مرتبط.`);
                    }
                });
        
            } catch (error) {
                console.error('Error loading teachers:', error); // تم تغيير النص ليكون أدق
                userSelectDropdown.innerHTML = '<option value="" disabled selected>فشل التحميل</option>';
            }
        }
        
        async function loadAndSetUserRole(userId) {
            try {
                const response = await fetch(`${API_BASE_URL}/users/${userId}/`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error('Failed to fetch user data');
                const user = await response.json();
                isStaffToggle.checked = user.is_staff;
                isSuperUserToggle.checked = user.is_superuser;
            } catch (error) {
                console.error('Error loading user role:', error);
                alert('فشل في تحميل بيانات المستخدم.');
            }
        }
        
        // --- منطق الأحداث ---

        showView('list'); // عرض الواجهة الابتدائية

        showCreateUserFormBtn.addEventListener('click', showCreateForm);
        backToListBtn.addEventListener('click', () => showView('list'));

        userSelectDropdown.addEventListener('change', () => {
            if (userSelectDropdown.value) {
                goToEditBtn.disabled = false;
                goToEditBtn.classList.add('bg-blue-600');
                goToEditBtn.classList.remove('bg-gray-500', 'cursor-not-allowed');
            }
        });

        goToEditBtn.addEventListener('click', () => {
            const selectedUserId = userSelectDropdown.value;
            if (!selectedUserId) return;
            const selectedUserName = userSelectDropdown.options[userSelectDropdown.selectedIndex].text;
            showPermissionsForm(selectedUserId, selectedUserName, 'edit');
        });

        createUserForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            setButtonLoading(createUserBtn, true);
            const teacher_name = document.getElementById('username').value;
            const teacher_email = document.getElementById('email').value;
            const teacher_status = document.getElementById('password').value;

            try {
                const response = await fetch(`${API_BASE_URL}/teachers/`, { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ teacher_name, teacher_email, teacher_status })
                });
                const data = await response.json();
                if (!response.ok) {
                    displayErrors(data);
                    throw new Error('Validation failed');
                }
                showPermissionsForm(data.user.id, data.teacher_name, 'create');
            } catch (error) {
                console.error('Error creating user:', error);
            } finally {
                setButtonLoading(createUserBtn, false);
            }
        });

        savePermissionsBtn.addEventListener('click', async () => {
            setButtonLoading(savePermissionsBtn, true);
            const payload = { is_staff: isStaffToggle.checked ,is_superuser: isSuperUserToggle.checked};

            try {
                const response = await fetch(`${API_BASE_URL}/users/${currentUserId}/`, {
                    method: 'PATCH',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Failed to save role:', errorData);
                    throw new Error('Failed to save role');
                }
                
                permissionsSuccessDiv.textContent = 'تم حفظ الدور بنجاح!';
                permissionsSuccessDiv.classList.remove('hidden');
                setTimeout(() => permissionsSuccessDiv.classList.add('hidden'), 4000);

            } catch (error) {
                console.error('Error saving role:', error);
                alert('فشل في حفظ الدور.');
            } finally {
                setButtonLoading(savePermissionsBtn, false);
            }
        });
    });
</script>
{% endblock %}